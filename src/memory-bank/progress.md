# Progress

## What Works

- **Critical Rule Enforced (Apr 26, 2025):** After a code loss incident in `WodViewer.test.tsx` (where code was omitted and replaced with comments/ellipsis), a strict rule is now enforced: Never summarize or omit code or documentation in any file. All files must always be complete and explicit. Summarization, ellipsis, or "omitted for brevity" is strictly forbidden. This rule is now documented in the memory bank and system patterns.
- **AuthControls.test.tsx Mock Fix (Apr 22, 2025):** Fixed a test failure in the AuthControls component tests by updating the mock for env.js to use a named export called `env` instead of a default export. Also updated several other mock files to use the same structure, added missing environment variables, and fixed test selectors. All tests in `AuthControls.test.tsx` now pass successfully, ensuring the profile dropdown export feature is fully tested.

- **Import Page Radix UI Tabs (Apr 21, 2025):** The import page now uses Radix UI Tabs instead of custom tab implementation. This provides better accessibility, theme consistency, and simpler code. The tabs switch between SugarWOD and PRzilla import options, with each tab content rendering the appropriate import wizard wrapper.

- **Lint Fix: Block-Style Disables for Test Mocks (Apr 21, 2025):**

  - Strict ESLint rules (`@typescript-eslint/no-explicit-any`, `@typescript-eslint/no-unsafe-argument`) flagged `as any` usage in test mocks in `src/app/_components/AuthControls.test.tsx`, causing `npm run lint` to fail.
  - Block-style disables (`/* eslint-disable ... */ ... /* eslint-enable ... */`) were applied around the tRPC mock return values in the test file. This is now the preferred approach for handling strict ESLint rules in test files.
  - The codebase is now lint/type clean.

- **Mobile WOD Card Blurb (Apr 21, 2025):** Each mobile WOD card now displays a short blurb under the workout title when collapsed, using the `difficultyExplanation` field if available, or a short description otherwise. This gives users a quick overview of each workout at a glance.

- **SugarWOD Import Instructions (Apr 20, 2025):** The import page (`/import`) now includes a clear instructional section within the `ScoreImportWizard` component. This section provides step-by-step guidance (go to profile, click 'Export Workouts', wait for email, upload CSV), a direct link to the SugarWOD profile page, and an embedded screenshot (`public/images/sugarwod_export.png`) showing the 'Export Workouts' button location. This improves the usability of the score import feature.

- **Mobile Log/Edit Score UI: Immediate UI Update (Apr 19, 2025):**

  - Logging, editing, and deleting a score on mobile now update the UI immediately and reliably, matching the desktop experience.
  - The fix involved adding an `onScoreLogged` prop to `WodListMobile`, passed from `WodViewer`, and wiring it through to `LogScoreForm`. After a successful log/edit, the parent is notified to invalidate and refetch the scores query.
  - All tests in `WodListMobile.test.tsx` now pass, including those for logging, editing, and deleting scores, and for UI updates after these actions.
  - The mobile score management UI is robust, fully tested, and at parity with desktop.

- **Mobile Score Log/Edit UI Fixes & Test Robustness (Apr 19, 2025):**

  - Logging and editing a score on mobile now properly update the UI, thanks to correct TanStack Query cache invalidation.
  - Automated tests for log/edit UI updates are in place and robust.
  - Dialog removal test is robust, checking for DOM removal using `screen.queryByRole("dialog")`.
  - TooltipProvider is used in all relevant tests to prevent Radix errors.
  - All critical tests now pass, and the mobile score management UI is reliable and fully tested.

- **Mobile Edit/Delete Score in Sheet (Apr 19, 2025):** Users can now edit or delete their logged scores directly from the mobile WOD sheet/card. Each score has edit and delete icons; edit opens the Drawer in edit mode, delete opens a confirmation dialog. State management is robust, and the Drawer title reflects the current mode. Comprehensive tests cover all flows (log, edit, delete, cancel) and are robust to UI animation quirks. Mobile score management is now at parity with desktop and fully reliable.

- **Mobile Log Score Drawer (Apr 19, 2025):** The "Log Score" button is now present in mobile view, opening a bottom sheet Drawer (shadcn/ui, vaul-based) for logging scores. The Drawer is accessible, mobile-friendly, and uses the shared LogScoreForm for all WOD types. Previous attempts to use a different bottom sheet library failed due to incompatibilities; shadcn/ui Drawer is robust and visually consistent. The Drawer closes on submit or cancel, and the UI is visually consistent with the app's design system.

- **23 New Benchmark WODs Added to JSON and Database (Apr 18, 2025):** 23 new skill/benchmark WODs (e.g., Handstand Push-Ups: Max Reps, L-Sit Hold: Max Time, Pull-up (Weighted): 1RM, etc.) were added to `public/data/wods.json` and inserted into the Turso production database using a dedicated script. The script (`scripts/add_new_wods_to_db.ts`) uses `TURSO_DATABASE_URL` and `TURSO_AUTH_TOKEN` from `.env` for production DB access, and leverages `onConflictDoNothing` to avoid duplicates. All new WODs are now present in both the static JSON and the production DB, with all fields mapped and formatted to the schema. This expands the system's benchmark/skill coverage and provides a repeatable pattern for future batch additions.

- **Log/Edit Score Dialog: Horizontal Reps/Rounds Layout (Apr 17, 2025):** The layout of the score logging/editing form (`LogScoreDialog.tsx`) has been improved. When applicable (e.g., user hit timecap, AMRAP WOD), the input fields for Reps, Rounds, and Partial Reps are now displayed horizontally on a single line using a `Flex` container, enhancing layout density and visual organization.
- **Timecap-Aware Log/Edit Score UI (Apr 16, 2025):** The log/edit score dialog now fully supports timecapped WODs. For WODs with a timecap, users are prompted with a vertical Radix UI radio group ("Finished within [timecap] timecap?"), and the form dynamically shows time or reps/rounds+reps input fields based on the user's selection. Validation and backend/frontend propagation are complete.
- **WOD Time Cap Extraction & Structured Data (Apr 16, 2025):** All WODs with a time cap have been identified using regex-based search on `public/data/wods.json`. Created `public/data/wods_with_timecaps.json` with WOD name, matched time cap string, and description for each match. This enables review, parsing, and backfilling of a structured `timecap` (seconds) field in the main dataset, supporting robust score logging and future analytics.

- **WOD Table "Difficulty" Tooltip Redesign (Apr 16, 2025):** The "Difficulty" column header tooltip now uses a dark background, light text, and no border/shadow, matching the style of charting tooltips. The tooltip is color-coded for each difficulty level, uses Radix UI Flex/Text for layout, and is fully accessible and theme-aware. This provides a visually consistent, highly readable, and accessible experience for users.
- **WOD Table Score Sorting (Apr 16, 2025):** The "Your Scores" column in the desktop `WodTable` component (`src/app/(main)/components/WodTable.tsx`) is now sortable. Clicking the header toggles sorting based on the calculated performance level of the user's latest score for each WOD (Elite > Advanced > Intermediate > Beginner > Rx > Scaled > No Score), using a custom TanStack Table `sortingFn`.
- **Performance Chart Tooltip Refinement (Apr 15, 2025):** The performance timeline chart (`WodTimelineChart.tsx`) tooltip breakdown has been significantly enhanced. It now displays each contributing score in a clear, highlighted format: `Your score of **[Score Value]** on *[WOD Name]* is [Original Level (colored)] ([Level Num]). Adjusted for difficulty ([Difficulty]) it's [Adjusted Level Desc (colored)] ([Adjusted Level Num]).` The raw score value is shown, key elements are highlighted (bold score, italic WOD name, colored levels), and the adjustment text is conditionally hidden for "Medium" difficulty WODs to improve conciseness. This builds upon the previous adjusted level calculation and tooltip enhancements.
- **Log Score UI Refactor: Popover to Dialog (Apr 15, 2025):** The score logging and editing interface now uses a centered modal dialog (`LogScoreDialog.tsx`) instead of a popover. This provides a more focused user experience and aligns with other dialogs in the app. The core logic and state handling are preserved. The dialog now correctly inherits Radix Theme styles by rendering its portal into a container within `PageLayout.tsx`. The Rx input uses a Radix UI `Switch` instead of a `Checkbox`. The Date input (with label) and Rx Switch are arranged horizontally. The "Minutes" and "Seconds" input fields have been narrowed for a more compact layout.
- **Lint, Type Safety, and Code Cleanup (Apr 2025):** All TypeScript/ESLint errors and warnings related to unsafe `any` usage, floating promises, and unused variables/imports have been resolved. The codebase is now fully type-safe and clean, providing a robust foundation for future development.
  - As of April 14, 2025: All test files, test-utils, and WodTable.tsx are fully compliant with lint and type safety rules. All test mocks use proper eslint-disable comments for empty methods, test-utils is type-safe, and WodTable.tsx unconditionally calls all hooks. The codebase passes lint and typecheck with zero errors or warnings.
- **Score Tooltip & Info Icon Update (Apr 2025):** The "your score" cell in the WOD table now shows all relevant information (logged date, notes, user level, and benchmark breakdown) in a single tooltip for each score badge. The info icon and its tooltip have been removed. If there are no scores, only the Log Score trigger is shown. This streamlines the UI and improves clarity.
- **Score Edit/Delete & Validation (Apr 2025):** Users can now edit or delete any logged score directly from the WOD table. Edit and delete icons are shown for each score. The edit icon opens the log score dialog in edit mode, pre-filled with the score's data, and updates the score on submit. The delete icon opens a confirmation dialog and deletes the score on confirm. Validation now prevents empty or invalid results from being logged for all score types.
- **Log Score (Apr 2025):** Users can log a score for any WOD directly from the main table via a minimal dialog form (`LogScoreDialog.tsx`) featuring a `Switch` for Rx input, an improved Date/Rx layout, and narrower time inputs. The form adapts to WOD type, and the scores list refreshes automatically after logging. (Next: implement always-visible log score button in mobile list view.)
- **CSV/SugarWOD Score Import:** The full import flow is functional. Users can upload a CSV file via the dedicated `/import` route, review matched scores in `ScoreReviewTable`, confirm selections in `ImportConfirmation`, and the `ScoreImportWizard` component handles the process, submitting selected scores to the backend via the `api.score.importScores` tRPC mutation for insertion into the database. Includes client-side parsing, WOD matching (case-insensitive), validation, and UI feedback for loading/success/error states.

- **Profile Dropdown Export (Apr 21, 2025):** Users can now export their workout data (scores and WODs) as CSV or JSON directly from the profile dropdown in the main app header. The export options are only enabled when data is loaded, and the UI is minimal, theme-aware, and accessible. Implementation: `src/app/_components/AuthControls.tsx`, `src/utils/exportUserData.tsx`.

- **Profile Export QA & Test Coverage (Apr 21, 2025):**
  - Refactored `exportUserData.tsx` for testability (papaparse injection).
  - Added comprehensive utility tests (CSV/JSON, file download, error handling, edge cases).
  - Created UI tests for the export dropdown (accessibility, enabled/disabled state, correct invocation).
  - Utility tests pass; UI tests are implemented and ready to run with the required env var.
  - Next: Run UI tests with `NEXT_PUBLIC_BETTER_AUTH_URL` set, then perform manual QA of exported files in the browser.
- **Authentication Migration:** Successfully migrated from NextAuth.js to Better Auth, including database schema updates, API routes, client/server integration, and new login/signup/password reset pages.
- **Wodwell icon link in mobile view:** A circular Wodwell icon (white "w" on black) now appears to the left of the likes count in each mobile WOD card header if `wod.wodUrl` exists. The icon links to the WOD's Wodwell.com page, opens in a new tab, is accessible, and does not interfere with card expand/collapse.
- **Scaled badge display:** All non-Rx (scaled) scores now show a "Scaled" badge in grey, both in table and mobile views, ensuring accurate and consistent level display.
- **PageLayout:** Consistent page structure with Header component now implemented across all pages via `PageLayout` component. Includes standardized content container styling and ensures uniform header display. Added an ID (`page-layout-container`) to the root Box for portal targeting.
- **Initial Load Performance:** WOD data is now fetched server-side in `src/app/(main)/page.tsx` (previously `src/app/page.tsx`) and passed as a prop (`initialWods`) to `WodViewer`, significantly improving initial load time and LCP.
- **WOD Display:**
  - Core components for displaying WOD information (`WodViewer`, `WodTable`, `WodListMobile`) are functional.
  - `WodViewer` uses initial data from props for the first render and fetches scores client-side via tRPC (`api.score.getAllByUser`). The `api.wod.getAll` query remains for caching/updates.
  - **Mobile View (`WodListMobile.tsx`):** - Displays WODs as cards. - Cards are expandable via click on the header area (chevron icon indicates state). - **Search Highlighting & Auto-Expand:** Cards automatically expand if their content (name, tags, description) matches the active search term. Matching text is highlighted using the shared `HighlightMatch` component (`src/utils/uiUtils.tsx`). - Expanded view shows WOD description and user scores (with correct dates). - Includes a visual separator between description and scores. - **Score Notes:** Displays score notes (if they exist) below the score/Rx/date line in a smaller font.
